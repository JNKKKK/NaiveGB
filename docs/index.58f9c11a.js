var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},e={},s={},i=t.parcelRequire0263;null==i&&((i=function(t){if(t in e)return e[t].exports;if(t in s){var i=s[t];delete s[t];var h={id:t,exports:{}};return e[t]=h,i.call(h.exports,h,h.exports),h.exports}var r=new Error("Cannot find module '"+t+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(t,e){s[t]=e},t.parcelRequire0263=i),i.register("kjyEk",(function(t,e){})),i.register("hPtJY",(function(t,e){var s,i,h=t.exports={};function r(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function n(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(e){try{return s.call(null,t,0)}catch(e){return s.call(this,t,0)}}}!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(t){i=a}}();var g,c=[],l=!1,o=-1;function p(){l&&g&&(l=!1,g.length?c=g.concat(c):o=-1,c.length&&u())}function u(){if(!l){var t=n(p);l=!0;for(var e=c.length;e;){for(g=c,c=[];++o<e;)g&&g[o].run();o=-1,e=c.length}g=null,l=!1,function(t){if(i===clearTimeout)return clearTimeout(t);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(t);try{i(t)}catch(e){try{return i.call(null,t)}catch(e){return i.call(this,t)}}}(t)}}function d(t,e){this.fun=t,this.array=e}function b(){}h.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var s=1;s<arguments.length;s++)e[s-1]=arguments[s];c.push(new d(t,e)),1!==c.length||l||n(u)},d.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=b,h.addListener=b,h.once=b,h.off=b,h.removeListener=b,h.removeAllListeners=b,h.emit=b,h.prependListener=b,h.prependOnceListener=b,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}}));var h=class{constructor(t){this.ngb=t}init(){this.TIMER=this.ngb.TIMER,this.MMU=this.ngb.MMU,this.GPU=this.ngb.GPU,this.APU=this.ngb.APU,this.debugger=this.ngb.debugger,this.reg={a:0,b:0,c:0,d:0,e:0,h:0,l:0,f:0,sp:0,pc:0,i:0,r:0,m:0,t:0,ime:0},this.halt=0,this.halt_bug=!1,this.stop=0,this.instructions=Array(512).fill(void 0);let t={a:7,b:0,c:1,d:2,e:3,h:4,l:5},e={bc:0,de:1,hl:2},s={bc:0,de:1,hl:2,af:3},i=[t=>!(t>>7),t=>t>>7,t=>!(16&t),t=>16&t],h=["nz","z","nc","c"],r=[0,8,16,24,32,40,48,56];for(let e in t){let s=t[e];for(let i in t){let h=t[i];this.instructions[64+(s<<3)+h]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld",e,i),this.reg[e]=this.reg[i],this.TIMER.step(1)}}}for(let e in t){let s=t[e];this.instructions[6+(s<<3)]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"ld",e,this.MMU.rb(this.reg.pc+1).toString(10)),this.increment_pc(1),this.reg[e]=this.MMU.rb(this.reg.pc),this.TIMER.step(2)}}for(let e in t){let s=t[e];this.instructions[64+(s<<3)+6]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld",e,"[hl]"),this.TIMER.step(1),this.reg[e]=this.MMU.rb((this.reg.h<<8)+this.reg.l),this.TIMER.step(1)}}for(let e in t){let s=t[e];this.instructions[112+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","[hl]",e),this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,this.reg[e]),this.TIMER.step(1)}}this.instructions[54]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"ld","[hl]",this.MMU.rb(this.reg.pc+1).toString(16)),this.increment_pc(1),this.TIMER.step(2),this.MMU.wb((this.reg.h<<8)+this.reg.l,this.MMU.rb(this.reg.pc)),this.TIMER.step(1)},this.instructions[10]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","a","[bc]"),this.TIMER.step(1),this.reg.a=this.MMU.rb((this.reg.b<<8)+this.reg.c),this.TIMER.step(1)},this.instructions[26]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","a","[de]"),this.TIMER.step(1),this.reg.a=this.MMU.rb((this.reg.d<<8)+this.reg.e),this.TIMER.step(1)},this.instructions[242]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","a",`[$ff${this.reg.c.toString(16).padStart(2,"0")}]`),this.TIMER.step(1),this.reg.a=this.MMU.rb(65280+this.reg.c),this.TIMER.step(1)},this.instructions[226]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld",`[$ff${this.reg.c.toString(16).padStart(2,"0")}]`,"a"),this.TIMER.step(1),this.MMU.wb(65280+this.reg.c,this.reg.a),this.TIMER.step(1)},this.instructions[240]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"ldh","a",`[$ff${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}]`),this.increment_pc(1),this.TIMER.step(2),this.reg.a=this.MMU.rb(65280+this.MMU.rb(this.reg.pc)),this.TIMER.step(1)},this.instructions[224]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"ldh",`[$ff${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}]`,"a"),this.increment_pc(1),this.TIMER.step(2),this.MMU.wb(65280+this.MMU.rb(this.reg.pc),this.reg.a),this.TIMER.step(1)},this.instructions[250]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"ld","a",`[$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}]`),this.TIMER.step(3),this.increment_pc(1),this.reg.a=this.MMU.rb(this.MMU.rw(this.reg.pc)),this.increment_pc(1),this.TIMER.step(1)},this.instructions[234]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"ld",`[$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}]`,"a"),this.increment_pc(1),this.TIMER.step(3),this.MMU.wb(this.MMU.rw(this.reg.pc),this.reg.a),this.increment_pc(1),this.TIMER.step(1)},this.instructions[42]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","a","[hl+]"),this.TIMER.step(1),this.reg.a=this.MMU.rb((this.reg.h<<8)+this.reg.l);let t=(this.reg.h<<8)+this.reg.l;t+=1,t&=65535,this.reg.h=t>>8,this.reg.l=255&t,this.TIMER.step(1)},this.instructions[58]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","a","[hl-]"),this.TIMER.step(1),this.reg.a=this.MMU.rb((this.reg.h<<8)+this.reg.l);let t=(this.reg.h<<8)+this.reg.l;t-=1,t&=65535,this.reg.h=t>>8,this.reg.l=255&t,this.TIMER.step(1)},this.instructions[2]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","[bc]","a"),this.TIMER.step(1),this.MMU.wb((this.reg.b<<8)+this.reg.c,this.reg.a),this.TIMER.step(1)},this.instructions[18]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","[de]","a"),this.TIMER.step(1),this.MMU.wb((this.reg.d<<8)+this.reg.e,this.reg.a),this.TIMER.step(1)},this.instructions[34]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","[hl+]","a"),this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,this.reg.a);let t=(this.reg.h<<8)+this.reg.l;t+=1,t&=65535,this.reg.h=t>>8,this.reg.l=255&t,this.TIMER.step(1)},this.instructions[50]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","[hl-]","a"),this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,this.reg.a);let t=(this.reg.h<<8)+this.reg.l;t-=1,t&=65535,this.reg.h=t>>8,this.reg.l=255&t,this.TIMER.step(1)};for(let t in e){let s=e[t];this.instructions[1+(s<<4)]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"ld",t,this.MMU.rw(this.reg.pc+1).toString(10)),this.increment_pc(1),this.reg[t.charAt(1)]=this.MMU.rb(this.reg.pc),this.increment_pc(1),this.reg[t.charAt(0)]=this.MMU.rb(this.reg.pc),this.TIMER.step(3)}}this.instructions[49]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"ld","sp",this.MMU.rw(this.reg.pc+1).toString(10)),this.increment_pc(1),this.reg.sp=this.MMU.rw(this.reg.pc),this.increment_pc(1),this.TIMER.step(3)},this.instructions[249]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ld","sp","hl"),this.reg.sp=(this.reg.h<<8)+this.reg.l,this.TIMER.step(2)};for(let t in s){let e=s[t];this.instructions[192+(e<<4)+5]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"push",t),this.reg.sp-=1,this.MMU.wb(this.reg.sp,this.reg[t.charAt(0)]),this.reg.sp-=1,this.MMU.wb(this.reg.sp,this.reg[t.charAt(1)]),this.TIMER.step(4)}}for(let t in s){let e=s[t];this.instructions[192+(e<<4)+1]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"pop",t),this.reg[t.charAt(1)]=this.MMU.rb(this.reg.sp),this.reg.sp+=1,this.reg[t.charAt(0)]=this.MMU.rb(this.reg.sp),this.reg.sp+=1,this.reg.f&=240,this.TIMER.step(3)}}this.instructions[248]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"ld","hl"),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc);t>127&&(t=-(1+~t&255));let e=(15&this.reg.sp)+t>15?1:0,s=(255&this.reg.sp)+t>255?1:0;t<0&&(e=(15&this.reg.sp)+t<0?0:1,s=(255&this.reg.sp)+t<0?0:1),t+=this.reg.sp,t&=65535,this.reg.h=t>>8,this.reg.l=255&t,this.reg.f=0+(e<<5)+(s<<4),this.TIMER.step(3)},this.instructions[8]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"ld",`[$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}]`,"sp"),this.increment_pc(1),this.MMU.wb(this.MMU.rw(this.reg.pc),255&this.reg.sp),this.MMU.wb(this.MMU.rw(this.reg.pc)+1,this.reg.sp>>8),this.increment_pc(1),this.TIMER.step(5)};for(let e in t){let s=t[e];this.instructions[128+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"add","a",e);let t=this.reg.a,s=this.reg[e];this.reg.a+=this.reg[e];let i=0,h=0,r=0;this.reg.a>255&&(r=1),this.reg.a&=255,0==this.reg.a&&(i=1),16&(this.reg.a^s^t)&&(h=1),this.reg.f=0+(i<<7)+(h<<5)+(r<<4),this.TIMER.step(1)}}this.instructions[198]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"add","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc),e=this.reg.a;this.reg.a+=t;let s=0,i=0,h=0;this.reg.a>255&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=0+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(2)},this.instructions[134]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"add","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=this.reg.a;this.reg.a+=t;let s=0,i=0,h=0;this.reg.a>255&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=0+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[136+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"adc","a",e);let t=this.reg.a,s=this.reg[e];this.reg.a+=this.reg[e],this.reg.a+=16&this.reg.f?1:0;let i=0,h=0,r=0;this.reg.a>255&&(r=1),this.reg.a&=255,0==this.reg.a&&(i=1),16&(this.reg.a^s^t)&&(h=1),this.reg.f=0+(i<<7)+(h<<5)+(r<<4),this.TIMER.step(1)}}this.instructions[206]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"adc","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc),e=this.reg.a;this.reg.a+=t,this.reg.a+=16&this.reg.f?1:0;let s=0,i=0,h=0;this.reg.a>255&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=0+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(2)},this.instructions[142]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"adc","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=this.reg.a;this.reg.a+=t,this.reg.a+=16&this.reg.f?1:0;let s=0,i=0,h=0;this.reg.a>255&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=0+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[144+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"sub","a",e);let t=this.reg.a,s=this.reg[e];this.reg.a-=this.reg[e];let i=0,h=0,r=0;this.reg.a<0&&(r=1),this.reg.a&=255,0==this.reg.a&&(i=1),16&(this.reg.a^s^t)&&(h=1),this.reg.f=64+(i<<7)+(h<<5)+(r<<4),this.TIMER.step(1)}}this.instructions[214]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"sub","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc),e=this.reg.a;this.reg.a-=t;let s=0,i=0,h=0;this.reg.a<0&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(2)},this.instructions[150]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"sub","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=this.reg.a;this.reg.a-=t;let s=0,i=0,h=0;this.reg.a<0&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[152+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"suc","a",e);let t=this.reg.a,s=this.reg[e];this.reg.a-=this.reg[e],this.reg.a-=16&this.reg.f?1:0;let i=0,h=0,r=0;this.reg.a<0&&(r=1),this.reg.a&=255,0==this.reg.a&&(i=1),16&(this.reg.a^s^t)&&(h=1),this.reg.f=64+(i<<7)+(h<<5)+(r<<4),this.TIMER.step(1)}}this.instructions[222]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"suc","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc),e=this.reg.a;this.reg.a-=t,this.reg.a-=16&this.reg.f?1:0;let s=0,i=0,h=0;this.reg.a<0&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(2)},this.instructions[158]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"sub","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=this.reg.a;this.reg.a-=t,this.reg.a-=16&this.reg.f?1:0;let s=0,i=0,h=0;this.reg.a<0&&(h=1),this.reg.a&=255,0==this.reg.a&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[160+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"and","a",e),this.reg.a&=this.reg[e];let t=0;0==this.reg.a&&(t=1),this.reg.f=0+(t<<7)+32+0,this.TIMER.step(1)}}this.instructions[230]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"and","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc);this.reg.a&=t;let e=0;0==this.reg.a&&(e=1),this.reg.f=0+(e<<7)+32+0,this.TIMER.step(2)},this.instructions[166]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"and","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l);this.reg.a&=t;let e=0;0==this.reg.a&&(e=1),this.reg.f=0+(e<<7)+32+0,this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[176+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"or","a",e),this.reg.a|=this.reg[e];let t=0;0==this.reg.a&&(t=1),this.reg.f=0+(t<<7)+0+0,this.TIMER.step(1)}}this.instructions[246]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"or","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc);this.reg.a|=t;let e=0;0==this.reg.a&&(e=1),this.reg.f=0+(e<<7)+0+0,this.TIMER.step(2)},this.instructions[182]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"or","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l);this.reg.a|=t;let e=0;0==this.reg.a&&(e=1),this.reg.f=0+(e<<7)+0+0,this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[168+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"xor","a",e),this.reg.a^=this.reg[e];let t=0;0==this.reg.a&&(t=1),this.reg.f=0+(t<<7)+0+0,this.TIMER.step(1)}}this.instructions[238]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"xor","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc);this.reg.a^=t;let e=0;0==this.reg.a&&(e=1),this.reg.f=0+(e<<7)+0+0,this.TIMER.step(2)},this.instructions[174]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"xor","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l);this.reg.a^=t;let e=0;0==this.reg.a&&(e=1),this.reg.f=0+(e<<7)+0+0,this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[184+s]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"cp","a",e);let t=this.reg.a;t-=this.reg[e];let s=0,i=0,h=0;t<0&&(h=1),t&=255,0==t&&(s=1),16&(this.reg.a^this.reg[e]^t)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)}}this.instructions[254]=()=>{this.TRACELOG&&this.debugger.tracelog(1,"cp","a",this.MMU.rb(this.reg.pc+1)),this.increment_pc(1);let t=this.MMU.rb(this.reg.pc),e=this.reg.a;e-=t;let s=0,i=0,h=0;e<0&&(h=1),e&=255,0==e&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(2)},this.instructions[190]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"cp","a","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=this.reg.a;e-=t;let s=0,i=0,h=0;e<0&&(h=1),e&=255,0==e&&(s=1),16&(this.reg.a^t^e)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[4+(s<<3)]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"inc",e);let t=this.reg[e];this.reg[e]+=1,this.reg[e]&=255;let s=0,i=0,h=this.reg.f>>4&1;0==this.reg[e]&&(s=1),16&(1^this.reg[e]^t)&&(i=1),this.reg.f=0+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)}}this.instructions[52]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"inc","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=t+1;e&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,e);let s=0,i=0,h=this.reg.f>>4&1;0==e&&(s=1),16&(e^t^1)&&(i=1),this.reg.f=0+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[5+(s<<3)]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"dec",e);let t=this.reg[e];this.reg[e]-=1,this.reg[e]&=255;let s=0,i=0,h=this.reg.f>>4&1;0==this.reg[e]&&(s=1),16&(1^this.reg[e]^t)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)}}this.instructions[53]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"dec","[hl]"),this.TIMER.step(1);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=t-1;e&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,e);let s=0,i=0,h=this.reg.f>>4&1;0==e&&(s=1),16&(1^e^t)&&(i=1),this.reg.f=64+(s<<7)+(i<<5)+(h<<4),this.TIMER.step(1)};for(let t in e){let s=e[t];this.instructions[9+(s<<4)]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"add","hl",t);let e=(this.reg.h<<8)+this.reg.l,s=(this.reg[t.charAt(0)]<<8)+this.reg[t.charAt(1)],i=this.reg.f>>7,h=(4095&e)+(4095&s)>4095?1:0,r=0;e+=s,e>65535&&(r=1),e&=65535,this.reg.h=e>>8,this.reg.l=255&e,this.reg.f=0+(i<<7)+(h<<5)+(r<<4),this.TIMER.step(2)}}this.instructions[57]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"add","hl","sp");let t=(this.reg.h<<8)+this.reg.l,e=this.reg.f>>7,s=(4095&t)+(4095&this.reg.sp)>4095?1:0,i=0;t+=this.reg.sp,t>65535&&(i=1),t&=65535,this.reg.h=t>>8,this.reg.l=255&t,this.reg.f=0+(e<<7)+(s<<5)+(i<<4),this.TIMER.step(2)},this.instructions[232]=()=>{let t=this.MMU.rb(this.reg.pc+1);t>127&&(t=-(1+~t&255)),this.TRACELOG&&this.debugger.tracelog(1,"add","sp",t),this.increment_pc(1);let e=(15&this.reg.sp)+t>15?1:0,s=(255&this.reg.sp)+t>255?1:0;t<0&&(e=(15&this.reg.sp)+t<0?0:1,s=(255&this.reg.sp)+t<0?0:1),this.reg.sp+=t,this.reg.sp&=65535,this.reg.f=0+(e<<5)+(s<<4),this.TIMER.step(4)};for(let t in e){let s=e[t];this.instructions[3+(s<<4)]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"inc",t);let e=(this.reg[t.charAt(0)]<<8)+this.reg[t.charAt(1)];e+=1,e&=65535,this.reg[t.charAt(0)]=e>>8,this.reg[t.charAt(1)]=255&e,this.TIMER.step(2)}}this.instructions[51]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"inc","sp");let t=this.reg.sp;t+=1,t&=65535,this.reg.sp=t,this.TIMER.step(2)};for(let t in e){let s=e[t];this.instructions[11+(s<<4)]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"dec",t);let e=(this.reg[t.charAt(0)]<<8)+this.reg[t.charAt(1)];e-=1,e&=65535,this.reg[t.charAt(0)]=e>>8,this.reg[t.charAt(1)]=255&e,this.TIMER.step(2)}}this.instructions[59]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"inc","sp");let t=this.reg.sp;t-=1,t&=65535,this.reg.sp=t,this.TIMER.step(2)},this.instructions[7]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"rcla",void 0);let t=128&this.reg.a?1:0;this.reg.f=t<<4,this.reg.a=(this.reg.a<<1)+t,this.reg.a&=255,this.TIMER.step(1)},this.instructions[23]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"rla",void 0);let t=128&this.reg.a?1:0;this.reg.a=(this.reg.a<<1)+(16&this.reg.f?1:0),this.reg.a&=255,this.reg.f=t<<4,this.TIMER.step(1)},this.instructions[15]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"rrca",void 0);let t=1&this.reg.a;this.reg.f=t<<4,this.reg.a=(this.reg.a>>1)+(t<<7),this.reg.a&=255,this.TIMER.step(1)},this.instructions[31]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"rra",void 0);let t=1&this.reg.a;this.reg.a=(this.reg.a>>1)+(16&this.reg.f?128:0),this.reg.a&=255,this.reg.f=t<<4,this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[256+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rlc",e);let t=128&this.reg[e]?1:0;this.reg[e]=(this.reg[e]<<1)+t,this.reg[e]&=255;let s=this.reg[e]?0:1;this.reg.f=(s<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[262]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rlc","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=128&t?1:0;t=(t<<1)+e,t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[272+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rl",e);let t=128&this.reg[e]?1:0;this.reg[e]=(this.reg[e]<<1)+(16&this.reg.f?1:0),this.reg[e]&=255;let s=this.reg[e]?0:1;this.reg.f=(s<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[278]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rl","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=128&t?1:0;t=(t<<1)+(16&this.reg.f?1:0),t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[264+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rrc",e);let t=1&this.reg[e];this.reg[e]=(this.reg[e]>>1)+(t<<7),this.reg[e]&=255;let s=this.reg[e]?0:1;this.reg.f=(s<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[270]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rrc","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=1&t;t=(t>>1)+(e<<7),t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[280+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rr",e);let t=1&this.reg[e];this.reg[e]=(this.reg[e]>>1)+(16&this.reg.f?128:0),this.reg[e]&=255;let s=this.reg[e]?0:1;this.reg.f=(s<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[286]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"rr","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=1&t;t=(t>>1)+(16&this.reg.f?128:0),t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[288+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"sla",e);let t=128&this.reg[e]?1:0;this.reg[e]=this.reg[e]<<1,this.reg[e]&=255;let s=this.reg[e]?0:1;this.reg.f=(s<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[294]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"sla","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=128&t?1:0;t<<=1,t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[296+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"sra",e);let t=1&this.reg[e],s=128&this.reg[e]?1:0;this.reg[e]=(this.reg[e]>>1)+(s<<7),this.reg[e]&=255;let i=this.reg[e]?0:1;this.reg.f=(i<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[302]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"sra","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=1&t;t=(t>>1)+((128&t?1:0)<<7),t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[312+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"srl",e);let t=1&this.reg[e];this.reg[e]=this.reg[e]>>1,this.reg[e]&=255;let s=this.reg[e]?0:1;this.reg.f=(s<<7)+(t<<4),this.TIMER.step(2)}}this.instructions[318]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"srl","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l),e=1&t;t>>=1,t&=255,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let s=t?0:1;this.reg.f=(s<<7)+(e<<4),this.TIMER.step(1)};for(let e in t){let s=t[e];this.instructions[304+s]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"swap",e);let t=this.reg[e]>>4,s=15&this.reg[e];this.reg[e]=(s<<4)+t;let i=this.reg[e]?0:1;this.reg.f=i<<7,this.TIMER.step(2)}}this.instructions[310]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"swap","[hl]"),this.TIMER.step(2);let t=this.MMU.rb((this.reg.h<<8)+this.reg.l);t=((15&t)<<4)+(t>>4),this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,t);let e=t?0:1;this.reg.f=e<<7,this.TIMER.step(1)};for(let e of[0,1,2,3,4,5,6,7])for(let s in t){let i=t[s];this.instructions[320+(e<<3)+i]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"bit",e,s);let t=1&~(this.reg[s]>>e&1),i=this.reg.f>>4&1;this.reg.f=0+(t<<7)+32+(i<<4),this.TIMER.step(2)}}for(let t of[0,1,2,3,4,5,6,7])this.instructions[320+(t<<3)+6]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"bit",t,"[hl]"),this.TIMER.step(2);let e=1&~(this.MMU.rb((this.reg.h<<8)+this.reg.l)>>t&1),s=this.reg.f>>4&1;this.reg.f=0+(e<<7)+32+(s<<4),this.TIMER.step(1)};for(let e of[0,1,2,3,4,5,6,7])for(let s in t){let i=t[s];this.instructions[448+(e<<3)+i]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"set",e,s),this.reg[s]|=1<<e,this.TIMER.step(2)}}for(let t of[0,1,2,3,4,5,6,7])this.instructions[448+(t<<3)+6]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"set",t,"[hl]"),this.TIMER.step(2);let e=this.MMU.rb((this.reg.h<<8)+this.reg.l);e|=1<<t,this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,e),this.TIMER.step(1)};for(let e of[0,1,2,3,4,5,6,7])for(let s in t){let i=t[s];this.instructions[384+(e<<3)+i]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"res",e,s),this.reg[s]&=255&~(1<<e),this.TIMER.step(2)}}for(let t of[0,1,2,3,4,5,6,7])this.instructions[384+(t<<3)+6]=()=>{this.TRACELOG&&this.debugger.tracelog(-1,"res",t,"[hl]"),this.TIMER.step(2);let e=this.MMU.rb((this.reg.h<<8)+this.reg.l);e&=255&~(1<<t),this.TIMER.step(1),this.MMU.wb((this.reg.h<<8)+this.reg.l,e),this.TIMER.step(1)};this.instructions[195]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"jp",`$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}`),this.increment_pc(1),this.reg.pc=this.MMU.rw(this.reg.pc),this.reg.pc-=1,this.TIMER.step(4)};for(let t of[0,1,2,3])this.instructions[192+(t<<3)+2]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"jp",h[t],`$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}`),this.increment_pc(1),i[t](this.reg.f)?(this.reg.pc=this.MMU.rw(this.reg.pc),this.reg.pc-=1,this.TIMER.step(4)):(this.increment_pc(1),this.TIMER.step(3))};this.instructions[24]=()=>{let t=this.MMU.rb(this.reg.pc+1);t>127&&(t=-(1+~t&255)),this.TRACELOG&&this.debugger.tracelog(1,"jr",`${t>=0?"+":""}${t}`),this.increment_pc(1),this.reg.pc+=t,this.TIMER.step(3)};for(let t of[0,1,2,3])this.instructions[32+(t<<3)]=()=>{let e=this.MMU.rb(this.reg.pc+1);e>127&&(e=-(1+~e&255)),this.TRACELOG&&this.debugger.tracelog(1,"jr",h[t],`${e>=0?"+":""}${e}`),this.increment_pc(1),i[t](this.reg.f)?(this.reg.pc+=e,this.TIMER.step(3)):this.TIMER.step(2)};this.instructions[233]=()=>{let t=(this.reg.h<<8)+this.reg.l;this.TRACELOG&&this.debugger.tracelog(0,"jp","hl"),this.reg.pc=t,this.reg.pc-=1,this.TIMER.step(1)},this.instructions[205]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"call",`$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}`),this.reg.sp-=2,this.MMU.ww(this.reg.sp,this.reg.pc+3),this.increment_pc(1),this.reg.pc=this.MMU.rw(this.reg.pc),this.reg.pc-=1,this.TIMER.step(6)};for(let t of[0,1,2,3])this.instructions[192+(t<<3)+4]=()=>{this.TRACELOG&&this.debugger.tracelog(2,"call",h[t],`$${this.MMU.rb(this.reg.pc+2).toString(16).padStart(2,"0")}${this.MMU.rb(this.reg.pc+1).toString(16).padStart(2,"0")}`),i[t](this.reg.f)?(this.reg.sp-=2,this.MMU.ww(this.reg.sp,this.reg.pc+3),this.increment_pc(1),this.reg.pc=this.MMU.rw(this.reg.pc),this.reg.pc-=1,this.TIMER.step(6)):(this.increment_pc(2),this.TIMER.step(3))};this.instructions[201]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ret"),this.reg.pc=this.MMU.rw(this.reg.sp),this.reg.pc-=1,this.reg.sp+=2,this.TIMER.step(4)},this.instructions[217]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"reti"),this.reg.pc=this.MMU.rw(this.reg.sp),this.reg.pc-=1,this.reg.sp+=2,this.reg.ime=1,this.TIMER.step(4)};for(let t of[0,1,2,3])this.instructions[192+(t<<3)]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ret",h[t]),i[t](this.reg.f)?(this.reg.pc=this.MMU.rw(this.reg.sp),this.reg.pc-=1,this.reg.sp+=2,this.TIMER.step(5)):this.TIMER.step(2)};for(let t of[0,1,2,3,4,5,6,7])this.instructions[192+(t<<3)+7]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"rst",t),this.reg.sp-=2,this.MMU.ww(this.reg.sp,this.reg.pc+1),this.reg.pc=r[t],this.reg.pc-=1,this.TIMER.step(4)};this.instructions[39]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"daa");let t=64&this.reg.f?1:0,e=32&this.reg.f?1:0,s=16&this.reg.f?1:0;t?(e&&(this.reg.a=this.reg.a-6&255),s&&(this.reg.a-=96)):(((15&this.reg.a)>9||e)&&(this.reg.a+=6),(this.reg.a>159||s)&&(this.reg.a+=96)),256&this.reg.a&&(s=1),this.reg.a&=255,this.reg.f&=64,this.reg.f&=208,0==this.reg.a&&(this.reg.f|=128),s&&(this.reg.f|=16),this.TIMER.step(1)},this.instructions[47]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"cpl"),this.reg.a^=255;let t=this.reg.f>>7,e=this.reg.f>>4&1;this.reg.f=64+(t<<7)+32+(e<<4),this.TIMER.step(1)},this.instructions[0]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"nop"),this.TIMER.step(1)},this.instructions[63]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ccf");let t=this.reg.f>>7,e=1&~(this.reg.f>>4&1);this.reg.f=0+(t<<7)+0+(e<<4),this.TIMER.step(1)},this.instructions[55]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"scf");let t=this.reg.f>>7;this.reg.f=0+(t<<7)+0+16,this.TIMER.step(1)},this.instructions[243]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"di"),this.reg.ime=0,this.TIMER.step(1)},this.instructions[251]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"ei"),this.reg.ime=1,this.TIMER.step(1)},this.instructions[118]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"halt"),this.halt=1,!this.reg.ime&&this.MMU.ie&this.MMU.if&&(this.halt_bug=!0),this.TIMER.step(1)},this.instructions[16]=()=>{this.TRACELOG&&this.debugger.tracelog(0,"stop"),this.TIMER.step(1)},this.instructions[203]=()=>{this.increment_pc(1),this.instructions[256+this.MMU.rb(this.reg.pc)]()}}increment_pc(t){this.halt_bug&&(this.halt_bug=!1,t-=1),t>0&&(this.reg.pc+=t)}reset(){for(let t in this.reg)this.reg[t]=0;this.halt=0,this.halt_bug=!1,this.stop=0,this.reg.ime=0}skip_bios(){this.reg.pc=256,this.MMU.inbios=0,this.reg.sp=65534,this.reg.a=1,this.reg.f=176,this.reg.b=0,this.reg.c=19,this.reg.d=0,this.reg.e=216,this.reg.h=1,this.reg.l=77,this.GPU.lcdc_7_enable=1}rst_interrupt(t){this.reg.sp-=2,this.MMU.ww(this.reg.sp,this.reg.pc),this.reg.pc=t,this.reg.ime=0,this.TIMER.step(4)}handle_interrupt(){if(this.reg.ime&&this.MMU.ie&&this.MMU.if){let t=this.MMU.ie&this.MMU.if;1&t?(this.MMU.if&=254,this.rst_interrupt(64),this.halt=0):2&t?(this.MMU.if&=253,this.rst_interrupt(72),this.halt=0):4&t?(this.MMU.if&=251,this.rst_interrupt(80),this.halt=0):8&t?(this.MMU.if&=247,this.rst_interrupt(88),this.halt=0):16&t&&(this.MMU.if&=239,this.rst_interrupt(96),this.halt=0)}this.halt&&!this.reg.ime&&this.MMU.ie&&this.MMU.if&&(this.halt=0)}exec(){if(this.halt)return void this.TIMER.step(1);if(this.stop)return;let t=this.MMU.rb(this.reg.pc);if("function"!=typeof this.instructions[t])return console.log("invalid instruction!",t),void(this.stop=1);this.instructions[t](),this.reg.pc+=1,this.reg.pc&=65535,this.MMU.inbios&&256==this.reg.pc&&(this.MMU.inbios=0)}};var r=class{constructor(t){this.ngb=t}init(){this.bios=[49,254,255,175,33,255,159,50,203,124,32,251,33,38,255,14,17,62,128,50,226,12,62,243,226,50,62,119,119,62,252,224,71,17,4,1,33,16,128,26,205,149,0,205,150,0,19,123,254,52,32,243,17,216,0,6,8,26,19,34,35,5,32,249,62,25,234,16,153,33,47,153,14,12,61,40,8,50,13,32,249,46,15,24,243,103,62,100,87,224,66,62,145,224,64,4,30,2,14,12,240,68,254,144,32,250,13,32,247,29,32,242,14,19,36,124,30,131,254,98,40,6,30,193,254,100,32,6,123,226,12,62,135,242,240,66,144,224,66,21,32,210,5,32,79,22,32,24,203,79,6,4,197,203,17,23,193,203,17,23,5,32,245,34,35,34,35,201,206,237,102,102,204,13,0,11,3,115,0,131,0,12,0,13,0,8,17,31,136,137,0,14,220,204,110,230,221,221,217,153,187,187,103,99,110,14,236,204,221,220,153,159,187,185,51,62,60,66,185,165,185,165,66,60,33,4,1,17,168,0,26,19,190,32,254,35,125,254,52,32,245,6,25,120,134,35,5,32,251,134,32,254,62,1,224,80],this.rom="",this.romBankCount=0,this.TIMER=this.ngb.TIMER,this.GPU=this.ngb.GPU,this.CPU=this.ngb.CPU,this.JOYPAD=this.ngb.JOYPAD,this.APU=this.ngb.APU,this.reset()}reset(){this.wram=Array(8192).fill(0),this.eram=Array(32768).fill(0),this.zram=Array(128).fill(0),this.inbios=1,this.ie=0,this.if=0,this.carttype=0,this.mbc=[{},{rombank:0,rambank:0,ramon:0,mode:0,maxRamBanks:4}],this.romoffs=16384,this.ramoffs=0}load_rom_ajax(t,e){let s=new XMLHttpRequest;s.open("GET",t,!0),s.responseType="arraybuffer",s.onload=()=>{let t=s.response;if(t){let s=new Uint8Array(t);this.loadRom(s),e&&e()}else console.log("AJAX load rom error!")},s.send(null)}load_rom_localfile(t){let e=i("kjyEk").readFileSync(t,"binary").toString("binary"),s=[];for(let t=0;t<e.length;t++)s.push(255&e.charCodeAt(t));this.loadRom(s)}loadRom(t){switch(this.rom=t,this.rom[327]){case 0:this.carttype=0;break;case 1:case 2:case 3:this.carttype=1;break;default:console.log("Cartridge Type: 0x",this.rom[327].toString(16),"is not supported. Fallback to 0"),this.carttype=0}this.romBankCount=Math.ceil(this.rom.length/16384)}rb(t){switch((t>65535||t<0)&&console.log("read memory overflow: ",t.toString("16")),61440&t){case 0:return this.inbios&&t<256?this.bios[t]:this.rom[t];case 4096:case 8192:case 12288:return this.rom[t];case 16384:case 20480:case 24576:case 28672:return this.rom[this.romoffs+(16383&t)];case 32768:case 36864:return this.GPU.vram[8191&t];case 40960:case 45056:return this.eram[this.ramoffs+(8191&t)];case 49152:case 53248:case 57344:return this.wram[8191&t];case 61440:switch(3840&t){case 0:case 256:case 512:case 768:case 1024:case 1280:case 1536:case 1792:case 2048:case 2304:case 2560:case 2816:case 3072:case 3328:return this.wram[8191&t];case 3584:return(255&t)<160?this.GPU.oam[255&t]:0;case 3840:if(65535==t)return 224|this.ie;if(t>65407)return this.zram[127&t];switch(240&t){case 0:switch(15&t){case 0:return this.JOYPAD.rb();case 4:case 5:case 6:case 7:return this.TIMER.rb(t);case 15:return 224|this.if;default:return 0}case 16:case 32:case 48:return this.APU.rb(t);case 64:case 80:case 96:case 112:return this.GPU.rb(t)}}}}rw(t){return this.rb(t)+(this.rb(t+1)<<8)}wb(t,e){switch((t>65535||t<0)&&(console.log("write memory overflow: ",t.toString("16")),console.log("mmu pc: ",this.CPU.reg.pc.toString("16"))),61440&t){case 0:case 4096:if(1===this.carttype)this.mbc[1].ramon=10==(15&e)?1:0;break;case 8192:case 12288:if(1===this.carttype)this.mbc[1].rombank&=96,(e&=31)||(e=1),32==e&&(e=33),64==e&&(e=65),96==e&&(e=97),this.mbc[1].rombank|=e,this.romoffs=this.mbc[1].rombank%this.romBankCount*16384;break;case 16384:case 20480:if(1===this.carttype)this.mbc[1].mode?(this.mbc[1].rambank=3&e,this.ramoffs=this.mbc[1].rambank%this.mbc[1].maxRamBanks*8192):(this.mbc[1].rombank&=31,this.mbc[1].rombank|=(3&e)<<5,this.romoffs=this.mbc[1].rombank%this.romBankCount*16384);break;case 24576:case 28672:if(1===this.carttype)this.mbc[1].mode=1&e;break;case 32768:case 36864:this.GPU.vram[8191&t]=e,t>=32768&&t<=38911&&this.GPU.update_tileset(8191&t),t>=38912&&t<=40959&&this.GPU.update_tilemap(8191&t);break;case 40960:case 45056:this.eram[this.ramoffs+(8191&t)]=e;break;case 49152:case 53248:case 57344:this.wram[8191&t]=e;break;case 61440:switch(3840&t){case 0:case 256:case 512:case 768:case 1024:case 1280:case 1536:case 1792:case 2048:case 2304:case 2560:case 2816:case 3072:case 3328:this.wram[8191&t]=e;break;case 3584:(255&t)<160&&(this.GPU.oam[255&t]=e,this.GPU.update_oam(255&t));break;case 3840:if(65535==t)this.ie=31&e;else if(t>65407)this.zram[127&t]=e;else if(65281==t)if("undefined"!=typeof window)console.log(String.fromCharCode(e));else if(void 0!==this.ngb.jest)this.ngb.jest.serialBuffer+=String.fromCharCode(e);else{i("hPtJY").stdout.write(String.fromCharCode(e))}else switch(240&t){case 0:switch(15&t){case 0:this.JOYPAD.wb(e);break;case 4:case 5:case 6:case 7:this.TIMER.wb(t,e);break;case 15:this.if=31&e}break;case 16:case 32:case 48:this.APU.wb(t,e);break;case 64:case 80:case 96:case 112:this.GPU.wb(t,e)}}}}ww(t,e){this.wb(t,255&e),this.wb(t+1,e>>8)}};var a=class{constructor(t){this.ngb=t}init(){this.MMU=this.ngb.MMU,this.GPU=this.ngb.GPU,this.APU=this.ngb.APU,this.reset()}reset(){this.reg={divider:0,counter:0,modulo:0,control:0},this.total_m=0,this.temp_m=0,this.div_m=0,this.cnt_m=0}step(t){if(this.total_m+=t,this.temp_m+=t,this.div_m+=t,this.div_m>=64&&(this.div_m-=64,this.reg.divider+=1,this.reg.divider&=255),4&this.reg.control){this.cnt_m+=t;let e=4;for(0==(3&this.reg.control)&&(e=256),1==(3&this.reg.control)&&(e=4),2==(3&this.reg.control)&&(e=16),3==(3&this.reg.control)&&(e=64);this.cnt_m>=e;)this.cnt_m-=e,this.reg.counter+=1,this.reg.counter>255&&(this.reg.counter=this.reg.modulo,this.MMU.if|=4)}this.GPU.step(t),this.APU.step(t)}rb(t){switch(t){case 65284:return this.reg.divider;case 65285:return this.reg.counter;case 65286:return this.reg.modulo;case 65287:return this.reg.control}}wb(t,e){switch(t){case 65284:this.reg.divider=0;break;case 65285:this.reg.counter=e;break;case 65286:this.reg.modulo=e;break;case 65287:(4&this.reg.control)!=(4&e)&&(this.cnt_m=0),this.reg.control=7&e}}};var n=class{constructor(t){this.ngb=t}init(){this.MMU=this.ngb.MMU,this.reset()}reset(){if(this.lcdc_0_bg_disp=0,this.lcdc_1_obj_enable=0,this.lcdc_2_obj_size=0,this.lcdc_3_tilemap=0,this.lcdc_4_tileset=0,this.lcdc_5_win_enable=0,this.lcdc_6_win_tilemap=0,this.lcdc_7_enable=0,this.stat_01_mode=2,this.stat_2_lyc_ly=0,this.stat_3_hb_int=0,this.stat_4_vb_int=0,this.stat_5_oam_int=0,this.stat_6_lyc_int=0,this.reg={},this.reg.scy=0,this.reg.scx=0,this.reg.ly=0,this.reg.lyc=0,this.reg.wy=0,this.reg.wx=0,this.reg.bg_palette=0,this.reg.obj_palette0=0,this.reg.obj_palette1=0,this.modeclocks=0,this.palette={bg:Array(4).fill(0).map((()=>[0,0,0,255])),obj:[Array(4).fill(0).map((()=>[0,0,0,255])),Array(4).fill(0).map((()=>[0,0,0,255]))]},this.vram=Array(8192).fill(0),this.oam=Array(160).fill(0),this.tileset=Array(384).fill(0).map((()=>Array(64).fill(0))),this.tilemap=[],this.tilemap[0]=Array(1024).fill(0).map((()=>[Array(64).fill(0),Array(64).fill(0)])),this.tilemap[1]=Array(1024).fill(0).map((()=>[Array(64).fill(0),Array(64).fill(0)])),this.sprite=Array(40).fill(0).map((()=>({y:0,x:0,pix_u:this.tileset[0],pix_l:this.tileset[0],x_flip:0,y_flip:0,priority_bg:0,palette:0,i:0}))),this.sprite.forEach(((t,e)=>t.i=e)),this.sprite_sorted=[],this.bg_alpha_map=Array(23040).fill(0),this.tilemap_index=[[],[]],this.headless=this.ngb.mode?.startsWith("headless"),this.headless){this.scrn={data:[]};for(let t=0;t<92160;t++)this.scrn.data[t]=255}}connect_canvas(t){try{this.canvas=t.getContext("2d"),this.scrn=this.canvas.createImageData(160,144);for(let t=0;t<this.scrn.data.length;t++)this.scrn.data[t]=255;this.canvas.putImageData(this.scrn,0,0)}catch(t){console.error(t),console.error("GPU: Canvas context could not be created.")}}render_bg(t){let e=0,s=this.reg.scy+t;for(let i=this.reg.scx;i<this.reg.scx+160;i++){let h=i;h>255&&(h-=256),s>255&&(s-=256);let r=this.tilemap[this.lcdc_3_tilemap][32*Math.floor(s/8)+Math.floor(h/8)][this.lcdc_4_tileset][s%8*8+h%8];for(let s of this.palette.bg[r])this.scrn.data[640*t+e]=s,e+=1;0==this.palette.bg[r][3]?this.bg_alpha_map[160*t+h]=1:this.bg_alpha_map[160*t+h]=0}}render_window(t){if(t<this.reg.wy)return;let e=0,s=t-this.reg.wy;for(let i=0;i<160-(this.reg.wx-7);i++){let h=this.tilemap[this.lcdc_6_win_tilemap][32*Math.floor(s/8)+Math.floor(i/8)][this.lcdc_4_tileset][s%8*8+i%8];for(let s of this.palette.bg[h])this.scrn.data[640*t+4*(this.reg.wx-7)+e]=s,e+=1;0==this.palette.bg[h][3]?this.bg_alpha_map[160*t+(this.reg.wx-7)+i]=1:this.bg_alpha_map[160*t+(this.reg.wx-7)+i]=0}}render_sprite(t){function e(t,e,s){let i=t[e];t[e]=t[s],t[s]=i}this.sprite_sorted.filter((t=>this.lcdc_2_obj_size?t.x>0&&t.x<168&&t.y>0&&t.y<160:t.x>0&&t.x<168&&t.y>8&&t.y<160)).filter((e=>t>=e.y-16&&t<=e.y-16+(this.lcdc_2_obj_size?16:8))).forEach((s=>{let i=Array.from(this.lcdc_2_obj_size?s.pix_u.concat(s.pix_l):s.pix_u);if(s.x_flip)for(let t=0;t<(this.lcdc_2_obj_size?16:8);t++)for(let s=0;s<4;s++)e(i,8*t+s,8*t+7-s);if(s.y_flip)for(let t=0;t<8;t++)for(let s=0;s<(this.lcdc_2_obj_size?8:4);s++)e(i,8*s+t,8*((this.lcdc_2_obj_size?16:8)-1-s)+t);i.forEach(((e,i)=>{if(!e)return;let h=i%8+s.x-8,r=Math.floor(i/8)+s.y-16;if(r==t&&h>=0&&h<=160&&r>=0&&r<=144)if(s.priority_bg){if(this.bg_alpha_map[160*r+h])for(let t of[0,1,2,3])this.scrn.data[4*(160*r+h)+t]=this.palette.obj[s.palette][e][t]}else for(let t of[0,1,2,3])this.scrn.data[4*(160*r+h)+t]=this.palette.obj[s.palette][e][t]}))}))}update_tileset(t){let e=Math.floor(t/16),s=Math.floor(t%16/2);for(let t=7;t>=0;t--){let i=this.vram[16*e+2*s]>>t&1,h=this.vram[16*e+2*s+1]>>t&1;this.tileset[e][8*s+7-t]=(h<<1)+i}}update_tilemap(t){let e;t>=6144&&t<=7167&&(e=0),t>=7168&&t<=8191&&(e=1);let s=this.vram[t],i=128+(this.vram[t]+128&255);this.tilemap[e][t-6144-1024*e]=[this.tileset[i],this.tileset[s]],this.tilemap_index[e][t-6144-1024*e]=this.vram[t]}update_oam(t){let e=Math.floor(t/4);this.sprite[e].y=this.oam[4*e],this.sprite[e].x=this.oam[4*e+1],this.lcdc_2_obj_size?(this.sprite[e].pix_u=this.tileset[254&this.oam[4*e+2]],this.sprite[e].pix_l=this.tileset[255&this.oam[4*e+2]|1]):this.sprite[e].pix_u=this.tileset[255&this.oam[4*e+2]];let s=this.oam[4*e+3];this.sprite[e].palette=s>>4&1,this.sprite[e].x_flip=s>>5&1,this.sprite[e].y_flip=s>>6&1,this.sprite[e].priority_bg=s>>7&1,this.sprite_sorted=Array.from(this.sprite),this.sprite_sorted.sort(((t,e)=>t.x!=e.x?e.x-t.x:e.i-t.i))}check_ly_lyc(){this.reg.ly==this.reg.lyc?(this.stat_2_lyc_ly=1,this.stat_6_lyc_int&&(this.MMU.if|=2)):this.stat_2_lyc_ly=0}render(t){this.lcdc_7_enable&&(this.lcdc_0_bg_disp&&this.render_bg(t),this.lcdc_5_win_enable&&this.render_window(t),this.lcdc_1_obj_enable&&this.render_sprite(t)),this.headless||this.canvas.putImageData(this.scrn,0,0)}step(t){if(!this.lcdc_7_enable)return this.modeclocks=0,this.stat_01_mode=2,void(this.reg.ly=0);switch(this.modeclocks+=t,this.stat_01_mode){case 0:this.modeclocks>=51&&(143==this.reg.ly?(this.stat_01_mode=1,this.MMU.if|=1,this.stat_4_vb_int&&(this.MMU.if|=2)):(this.stat_01_mode=2,this.stat_5_oam_int&&(this.MMU.if|=2)),this.reg.ly++,this.check_ly_lyc(),this.modeclocks-=51);break;case 1:this.modeclocks>=114&&(this.modeclocks-=114,this.reg.ly++,this.check_ly_lyc(),1==this.reg.ly&&(this.reg.ly=0,this.stat_01_mode=2),153==this.reg.ly&&(this.reg.ly=0));break;case 2:this.modeclocks>=20&&(this.modeclocks-=20,this.stat_01_mode=3);break;case 3:this.modeclocks>=43&&(this.modeclocks-=43,this.stat_01_mode=0,this.stat_3_hb_int&&(this.MMU.if|=2),this.render(this.reg.ly))}}rb(t){switch(15&t){case 0:return(this.lcdc_7_enable<<7)+(this.lcdc_6_win_tilemap<<6)+(this.lcdc_5_win_enable<<5)+(this.lcdc_4_tileset<<4)+(this.lcdc_3_tilemap<<3)+(this.lcdc_2_obj_size<<2)+(this.lcdc_1_obj_enable<<1)+this.lcdc_0_bg_disp;case 1:return(this.stat_6_lyc_int<<6)+(this.stat_5_oam_int<<5)+(this.stat_4_vb_int<<4)+(this.stat_3_hb_int<<3)+(this.stat_2_lyc_ly<<2)+this.stat_01_mode;case 2:return this.reg.scy;case 3:return this.reg.scx;case 4:return this.reg.ly;case 5:return this.reg.lyc;case 7:return this.reg.bg_palette;case 8:return this.reg.obj_palette0;case 9:return this.reg.obj_palette1;case 10:return this.reg.wy;case 11:return this.reg.wx;default:return 255}}wb(t,e){switch(15&t){case 0:this.lcdc_0_bg_disp=1&e,this.lcdc_1_obj_enable=(2&e)>>1,this.lcdc_2_obj_size=(4&e)>>2,this.lcdc_3_tilemap=(8&e)>>3,this.lcdc_4_tileset=(16&e)>>4,this.lcdc_5_win_enable=(32&e)>>5,this.lcdc_6_win_tilemap=(64&e)>>6,this.lcdc_7_enable=(128&e)>>7;break;case 1:this.stat_3_hb_int=(8&e)>>3,this.stat_4_vb_int=(16&e)>>4,this.stat_5_oam_int=(32&e)>>5,this.stat_6_lyc_int=(64&e)>>6;break;case 2:this.reg.scy=e;break;case 3:this.reg.scx=e;break;case 4:(128&this.reg.ly)>>7&&(128&e)>>7&&(this.lcdc_7_enable=0,this.reg.ly=0);break;case 5:this.reg.lyc=e,this.check_ly_lyc();break;case 6:for(let t=0;t<160;t++){let s=this.MMU.rb((e<<8)+t);this.oam[t]=s,this.update_oam(t)}break;case 7:this.reg.bg_palette=e;for(let t=0;t<4;t++)switch(e>>2*t&3){case 0:this.palette.bg[t]=[255,255,255,0];break;case 1:this.palette.bg[t]=[192,192,192,255];break;case 2:this.palette.bg[t]=[96,96,96,255];break;case 3:this.palette.bg[t]=[0,0,0,255]}break;case 8:this.reg.obj_palette0=e;for(let t=0;t<4;t++)switch(e>>2*t&3){case 0:this.palette.obj[0][t]=[255,255,255,0];break;case 1:this.palette.obj[0][t]=[192,192,192,255];break;case 2:this.palette.obj[0][t]=[96,96,96,255];break;case 3:this.palette.obj[0][t]=[0,0,0,255]}break;case 9:this.reg.obj_palette1=e;for(let t=0;t<4;t++)switch(e>>2*t&3){case 0:this.palette.obj[1][t]=[255,255,255,0];break;case 1:this.palette.obj[1][t]=[192,192,192,255];break;case 2:this.palette.obj[1][t]=[96,96,96,255];break;case 3:this.palette.obj[1][t]=[0,0,0,255]}break;case 10:this.reg.wy=e;break;case 11:this.reg.wx=e}}};var g=class{constructor(t){this.ngb=t}init(){this.reset()}reset(){this.keys=[15,15],this.colidx=0}rb(){switch(this.colidx){case 0:default:return 0;case 16:return this.keys[0];case 32:return this.keys[1]}}wb(t){this.colidx=48&t}keydown(t){switch(t.keyCode){case 39:this.keys[1]&=14;break;case 37:this.keys[1]&=13;break;case 38:this.keys[1]&=11;break;case 40:this.keys[1]&=7;break;case 90:this.keys[0]&=14;break;case 88:this.keys[0]&=13;break;case 32:return this.keys[0]&=11,!1;case 13:return this.keys[0]&=7,!1}}keyup(t){switch(t.keyCode){case 39:this.keys[1]|=1;break;case 37:this.keys[1]|=2;break;case 38:this.keys[1]|=4;break;case 40:this.keys[1]|=8;break;case 90:this.keys[0]|=1;break;case 88:this.keys[0]|=2;break;case 32:return this.keys[0]|=5,!1;case 13:return this.keys[0]|=8,!1}}};class c{constructor(t,e,s){this.APU=t,this.channelNumber=e,this.audioContext=s}init(){this.reset()}reset(){this.reg={},this.reg.NR10=0,this.reg.NR11=0,this.reg.NR12=0,this.reg.NR13=0,this.reg.NR14=0,this.reg.NR21=0,this.reg.NR22=0,this.reg.NR23=0,this.reg.NR24=0,this.playing=!1,this.soundLength=64,this.lengthCheck=!1,this.sweepPeriod=0,this.sweepTimer=0,this.sweepShifts=0,this.sweepSign=1,this.sweepEnabled=0,this.sweepFrequency=0,this.sweepCalculatedSubtract=!1,this.frequency=0,this.envelopePeriod=0,this.envelopeTimer=0,this.envelopeSign=1,this.envelopeAutomatic=!1,this.envelopeInitialVolume=0,this.envelopeVolume=0;let t=this.audioContext.createGain();t.gain.value=0;let e=this.audioContext.createOscillator();e.type="square",e.frequency.value=1e3,e.connect(t),e.start(0),this.gainNode=t,this.oscillator=e}trigger(){this.playing=!0,this.APU.setChannelStatus(this.channelNumber,1),this.gainNode.connect(this.audioContext.destination),this.soundLength<=0&&(this.setLength(0),this.lengthCheck&&0==(1&this.APU.frame)&&this.soundLength--),this.sweepTimer=this.sweepPeriod?this.sweepPeriod:8,this.sweepEnabled=this.sweepShifts||this.sweepPeriod,this.sweepFrequency=this.frequency,this.sweepCalculatedSubtract=!1,this.sweepShifts&&this.calcSweepFreq()>2047&&this.stop(),this.setEnvelopeVolume(this.envelopeInitialVolume),this.envelopeTimer=this.envelopePeriod?this.envelopePeriod:8,this.envelopeAutomatic=!0,this.APU.frame+1==7&&(this.envelopeTimer+=1),1==this.channelNumber&&this.reg.NR12>>3==0&&this.stop(),2==this.channelNumber&&this.reg.NR22>>3==0&&this.stop()}stop(){this.playing=!1,this.APU.setChannelStatus(this.channelNumber,0),this.gainNode.disconnect()}calcSweepFreq(){let t=this.sweepFrequency,e=t+this.sweepSign*(t>>this.sweepShifts);return-1==this.sweepSign&&(this.sweepCalculatedSubtract=!0),e}setFrequency(t){this.frequency=t,this.oscillator.frequency.value=131072/(2048-this.frequency)}setLength(t){this.soundLength=64-(63&t)}setLengthCheck(t,e){!this.lengthCheck&&t&&0==(1&this.APU.frame)&&this.soundLength>0&&(this.soundLength--,0!=this.soundLength||e||this.stop()),this.lengthCheck=t}setEnvelopeVolume(t){this.envelopeVolume=t,this.gainNode.gain.value=1*this.envelopeVolume/100}mute(){this.oscillator.disconnect()}unmute(){this.oscillator.connect(this.gainNode)}updateSweep(){if(this.playing&&this.sweepEnabled&&(this.sweepTimer-=1,0==this.sweepTimer))if(this.sweepPeriod){this.sweepTimer=this.sweepPeriod;let t=this.calcSweepFreq();t>2047?this.stop():this.sweepShifts&&(this.reg.NR13=255&t,this.reg.NR14&=248,this.reg.NR14|=(1792&t)>>8,this.setFrequency(t),this.sweepFrequency=t,t=this.calcSweepFreq(),t>2047&&this.stop())}else this.sweepTimer=8}updateLength(){this.lengthCheck&&this.soundLength>0&&(this.soundLength--,0==this.soundLength&&this.stop())}updateEnvelope(){if(this.envelopePeriod){if(this.envelopeAutomatic&&(this.envelopeTimer-=1,0==this.envelopeTimer)){this.envelopeTimer=this.envelopePeriod;let t=this.envelopeVolume+this.envelopeSign;t<15&&t>=0?this.setEnvelopeVolume(t):this.envelopeAutomatic=!1}}else this.envelopeTimer=8}}class l{constructor(t,e,s){this.APU=t,this.channelNumber=e,this.audioContext=s}init(){this.reset()}reset(){this.reg={},this.reg.NR30=127,this.reg.NR31=0,this.reg.NR32=159,this.reg.NR33=0,this.reg.NR34=0,void 0===this.waveRam&&(this.waveRam=Array(16).fill(0)),this.playing=!1,this.soundLength=0,this.lengthCheck=!1,this.wavePeriod=0,this.waveCycles=0,this.wavePosition=0,this.waveSampleTime=0,this.wavePlaying=0,this.frequency=0,this.buffer=new Float32Array(32);let t=this.audioContext.createGain();t.gain.value=1,this.gainNode=t,this.baseSpeed=65536;let e=this.audioContext.createBuffer(1,32,this.baseSpeed),s=this.audioContext.createBufferSource();s.buffer=e,s.loop=!0,s.connect(t),s.start(0),this.waveBuffer=e,this.bufferSource=s}trigger(){if(this.playing=!0,this.APU.setChannelStatus(this.channelNumber,1),this.waveBuffer.copyToChannel(this.buffer,0,0),this.gainNode.connect(this.audioContext.destination),this.soundLength<=0&&(this.setLength(0),this.lengthCheck&&0==(1&this.APU.frame)&&this.soundLength--),this.wavePlaying&&4==this.waveCycles){let t=this.wavePosition+1&31,e=this.waveRam[t>>1];switch(t>>3){case 0:this.waveRam[0]=e;break;case 1:case 2:case 3:this.waveRam[0]=this.waveRam[t>>1&12],this.waveRam[1]=this.waveRam[1+(t>>1&12)],this.waveRam[2]=this.waveRam[2+(t>>1&12)],this.waveRam[3]=this.waveRam[3+(t>>1&12)]}}this.wavePosition=0,this.waveCycles=this.wavePeriod+8,this.wavePlaying=!0,this.reg.NR30>>7==0&&this.stop()}stop(){this.playing=!1,this.wavePlaying=!1,this.APU.setChannelStatus(this.channelNumber,0),this.gainNode.disconnect()}setFrequency(t){this.frequency=t,this.wavePeriod=2*(2048-this.frequency),t=65536/(2048-t),this.bufferSource.playbackRate.value=t/this.baseSpeed}getFrequency(){return 1|2048-65536/(this.bufferSource.playbackRate.value*this.baseSpeed)}setLength(t){this.soundLength=256-t}setLengthCheck(t,e){!this.lengthCheck&&t&&0==(1&this.APU.frame)&&this.soundLength>0&&(this.soundLength--,0!=this.soundLength||e||this.stop()),this.lengthCheck=t}setWaveBufferByte(t,e){let s=2*t;this.buffer[s]=(e>>4)/8-1,this.buffer[s+1]=(15&e)/8-1}mute(){this.bufferSource.disconnect()}unmute(){this.bufferSource.connect(this.gainNode)}updateLength(){this.lengthCheck&&this.soundLength>0&&(this.soundLength--,0==this.soundLength&&this.stop())}updateWave(t){let e=4*t;for(this.waveCycles-=e;this.waveCycles<=2;)this.wavePosition+=1,this.wavePosition>=32&&(this.wavePosition-=32),this.waveSampleTime=4*this.APU.ngb.TIMER.total_m-2+this.waveCycles,this.waveCycles+=this.wavePeriod}}class o{constructor(t,e,s){this.APU=t,this.channelNumber=e,this.audioContext=s}init(){this.reset()}reset(){this.reg={},this.reg.NR41=255,this.reg.NR42=0,this.reg.NR43=0,this.reg.NR44=0,this.playing=!1,this.soundLength=64,this.lengthCheck=!1,this.envelopePeriod=0,this.envelopeTimer=0,this.envelopeSign=1,this.envelopeAutomatic=!1,this.envelopeInitialVolume=0,this.envelopeVolume=0}trigger(){this.playing=!0,this.APU.setChannelStatus(this.channelNumber,1),this.soundLength<=0&&(this.setLength(0),this.lengthCheck&&0==(1&this.APU.frame)&&this.soundLength--),this.reg.NR42>>3==0&&this.stop()}stop(){this.playing=!1,this.APU.setChannelStatus(this.channelNumber,0)}updateLength(){this.lengthCheck&&this.soundLength>0&&(this.soundLength--,0==this.soundLength&&this.stop())}setEnvelopeVolume(t){this.envelopeVolume=t}updateEnvelope(){if(this.envelopePeriod){if(this.envelopeAutomatic&&(this.envelopeTimer-=1,0==this.envelopeTimer)){this.envelopeTimer=this.envelopePeriod;let t=this.envelopeVolume+this.envelopeSign;t<15&&t>=0?this.setEnvelopeVolume(t):this.envelopeAutomatic=!1}}else this.envelopeTimer=8}setLength(t){this.soundLength=64-(63&t)}setLengthCheck(t,e){!this.lengthCheck&&t&&0==(1&this.APU.frame)&&this.soundLength>0&&(this.soundLength--,0!=this.soundLength||e||this.stop()),this.lengthCheck=t}mute(){}unmute(){}}var p=class{constructor(t){this.ngb=t}init(){let t;if("undefined"!=typeof window){t=new(window.AudioContext||window.webkitAudioContext)}else t={createGain:()=>({gain:{value:0},connect:()=>{},disconnect:()=>{}}),createOscillator:()=>({type:0,frequency:{value:0},connect:()=>{},disconnect:()=>{},start:()=>{}}),createBuffer:()=>({copyToChannel:()=>{}}),createBufferSource:()=>({buffer:0,loop:0,connect:()=>{},disconnect:()=>{},start:()=>{},playbackRate:{value:0}})};this.channel1=new c(this,1,t),this.channel2=new c(this,2,t),this.channel3=new l(this,3,t),this.channel4=new o(this,4,t),this.reset()}reset(){this.reg={},this.reg.NR50=0,this.reg.NR51=0,this.reg.NR52=0,this.enabled=!1,this.channel1.init(),this.channel2.init(),this.channel3.init(),this.channel4.init(),this.mCycle=0,this.frame=7}step(t){if(this.mCycle+=t,this.channel3.playing&&this.channel3.updateWave(t),this.mCycle>=2048){if(this.mCycle-=2048,0==this.enabled)return;switch(this.frame=(this.frame+1)%8,this.frame){case 2:case 6:this.updateSweep();case 0:case 4:this.updateLength();break;case 7:this.updateEnvelope();break;case 1:case 3:case 5:break;default:console.log("invalid apu frame:",this.frame)}}}updateSweep(){this.channel1.updateSweep()}updateLength(){this.channel1.updateLength(),this.channel2.updateLength(),this.channel3.updateLength(),this.channel4.updateLength()}updateEnvelope(){this.channel1.updateEnvelope(),this.channel2.updateEnvelope(),this.channel4.updateEnvelope()}setChannelStatus(t,e){let s=255-(1<<t-1);e<<=t-1,this.reg.NR52&=s,this.reg.NR52|=e}skip_bios(){this.reg.NR52=241,this.channel1.reg.NR10=128,this.channel1.reg.NR11=191,this.channel3.reg.NR30=127,this.channel3.reg.NR32=159,this.channel4.reg.NR41=255,this.enabled=!0}rb(t){switch(t){case 65296:return 128|this.channel1.reg.NR10;case 65297:return 63|this.channel1.reg.NR11;case 65298:return this.channel1.reg.NR12;case 65299:return 255|this.channel1.reg.NR13;case 65300:return 191|this.channel1.reg.NR14;case 65302:return 63|this.channel2.reg.NR21;case 65303:return this.channel2.reg.NR22;case 65304:return 255|this.channel2.reg.NR23;case 65305:return 191|this.channel2.reg.NR24;case 65306:return 127|this.channel3.reg.NR30;case 65307:return 255|this.channel3.reg.NR31;case 65308:return 159|this.channel3.reg.NR32;case 65309:return 255|this.channel3.reg.NR33;case 65310:return 191|this.channel3.reg.NR34;case 65328:case 65329:case 65330:case 65331:case 65332:case 65333:case 65334:case 65335:case 65336:case 65337:case 65338:case 65339:case 65340:case 65341:case 65342:case 65343:return this.channel3.playing?this.channel3.waveSampleTime==4*this.ngb.TIMER.total_m?this.channel3.waveRam[this.channel3.wavePosition>>1]:255:this.channel3.waveRam[t-65328];case 65312:return 255|this.channel4.reg.NR41;case 65313:return this.channel4.reg.NR42;case 65314:return this.channel4.reg.NR43;case 65315:return 191|this.channel4.reg.NR44;case 65316:return this.reg.NR50;case 65317:return this.reg.NR51;case 65318:return 112|this.reg.NR52;default:return 255}}wb(t,e){if(!this.enabled&&65318!=t&&65297!=t&&65302!=t&&65307!=t&&65312!=t&&t<65328)return;let s,i;switch(t){case 65296:this.channel1.reg.NR10=128|e,this.channel1.sweepPeriod=(112&e)>>4,i=this.channel1.sweepSign,this.channel1.sweepSign=8&e?-1:1,-1==i&&1==this.channel1.sweepSign&&this.channel1.sweepCalculatedSubtract&&this.channel1.stop(),this.channel1.sweepShifts=7&e;break;case 65297:this.enabled&&(this.channel1.reg.NR11=e),this.channel1.setLength(63&e);break;case 65298:this.channel1.reg.NR12=e,this.channel1.envelopeSign=8&e?1:-1,this.channel1.envelopeInitialVolume=(240&e)>>4,this.channel1.envelopePeriod=7&e,e>>3==0?this.channel1.stop():0==this.channel1.envelopePeriod&&this.channel1.envelopeAutomatic&&this.channel1.setEnvelopeVolume(this.channel1.envelopeVolume+1&15);break;case 65299:this.channel1.reg.NR13=e,s=this.channel1.frequency,s&=3840,s|=e,this.channel1.setFrequency(s);break;case 65300:this.channel1.reg.NR14=e,s=this.channel1.frequency,s&=255,s|=(7&e)<<8,this.channel1.setFrequency(s),this.channel1.setLengthCheck(!!(64&e),!!(128&e)),128&e&&this.channel1.trigger();break;case 65302:this.enabled&&(this.channel2.reg.NR21=e),this.channel2.setLength(63&e);break;case 65303:this.channel2.reg.NR22=e,this.channel2.envelopeSign=8&e?1:-1,this.channel2.envelopeInitialVolume=(240&e)>>4,this.channel2.envelopePeriod=7&e,e>>3==0?this.channel2.stop():0==this.channel2.envelopePeriod&&this.channel2.envelopeAutomatic&&this.channel2.setEnvelopeVolume(this.channel2.envelopeVolume+1&15);break;case 65304:this.channel2.reg.NR23=e,s=this.channel2.frequency,s&=3840,s|=e,this.channel2.setFrequency(s);break;case 65305:this.channel2.reg.NR24=e,s=this.channel2.frequency,s&=255,s|=(7&e)<<8,this.channel2.setFrequency(s),this.channel2.setLengthCheck(!!(64&e),!!(128&e)),128&e&&this.channel2.trigger();break;case 65306:this.channel3.reg.NR30=127|e,e>>7==0&&this.channel3.stop();break;case 65307:this.enabled&&(this.channel3.reg.NR31=e),this.channel3.setLength(e);break;case 65308:this.channel3.reg.NR32=159|e;break;case 65309:this.channel3.reg.NR33=e,s=this.channel3.frequency,s&=3840,s|=e,this.channel3.setFrequency(s);break;case 65310:this.channel3.reg.NR34=e,s=this.channel3.frequency,s&=255,s|=(7&e)<<8,this.channel3.setFrequency(s),this.channel3.setLengthCheck(!!(64&e),!!(128&e)),128&e&&this.channel3.trigger();break;case 65328:case 65329:case 65330:case 65331:case 65332:case 65333:case 65334:case 65335:case 65336:case 65337:case 65338:case 65339:case 65340:case 65341:case 65342:case 65343:if(this.channel3.playing)this.channel3.waveSampleTime==4*this.ngb.TIMER.total_m&&(this.channel3.waveRam[this.channel3.wavePosition>>1]=e,this.channel3.setWaveBufferByte(this.channel3.wavePosition>>1,e));else{let s=t-65328;this.channel3.waveRam[s]=e,this.channel3.setWaveBufferByte(s,e)}break;case 65312:this.enabled&&(this.channel4.reg.NR41=192|e),this.channel4.setLength(63&e);break;case 65313:this.channel4.reg.NR42=e,this.channel4.envelopeSign=8&e?1:-1,this.channel4.envelopeInitialVolume=(240&e)>>4,this.channel4.envelopePeriod=7&e,e>>3==0?this.channel4.stop():0==this.channel4.envelopePeriod&&this.channel4.envelopeAutomatic&&this.channel4.setEnvelopeVolume(this.channel4.envelopeVolume+1&15);break;case 65314:this.channel4.reg.NR43=e;break;case 65315:this.channel4.reg.NR44=e,this.channel4.setLengthCheck(!!(64&e)),128&e&&this.channel4.trigger();break;case 65316:this.reg.NR50=e;break;case 65317:this.reg.NR51=e;break;case 65318:this.reg.NR52=240&e;let h=0!=(128&e);this.enabled&&!h&&(this.channel1.stop(),this.channel2.stop(),this.channel3.stop(),this.channel4.stop(),this.reset()),!this.enabled&&h&&(this.frame=7),this.enabled=h}}};var u=class{constructor(t){this.ngb=t}init(){this.CPU=this.ngb.CPU,this.GPU=this.ngb.GPU,this.MMU=this.ngb.MMU,this.TIMER=this.ngb.TIMER}print_tilemap(t,e){let s=[];t.tilemap_index[e].forEach(((t,e)=>{s.push(t),(e+1)%32==0&&(console.log(s.map((t=>t.toString("16").padStart(2,"0"))).join(",")),s=[])}))}tracelog(t,e,...s){let i=this.CPU.reg.a.toString("16").padStart(2,"0").toUpperCase(),h=this.CPU.reg.f>>7?"Z":"-";h+=this.CPU.reg.f>>6&1?"N":"-",h+=this.CPU.reg.f>>5&1?"H":"-",h+=this.CPU.reg.f>>4&1?"C":"-";let r,a=((this.CPU.reg.b<<8)+this.CPU.reg.c).toString("16").padStart(4,"0").toUpperCase(),n=((this.CPU.reg.d<<8)+this.CPU.reg.e).toString("16").padStart(4,"0"),g=((this.CPU.reg.h<<8)+this.CPU.reg.l).toString("16").padStart(4,"0"),c=this.CPU.reg.sp.toString("16").padStart(4,"0"),l=[];-1==t?(r=(this.CPU.reg.pc-1).toString("16").padStart(4,"0"),l.push("cb"),t=0):r=this.CPU.reg.pc.toString("16").padStart(4,"0");let o=4*this.TIMER.total_m;this.GPU.stat_01_mode;for(let e=0;e<t+1;e++)l.push(this.MMU.rb(this.CPU.reg.pc+e).toString("16").padStart(2,"0"));let p=`${e} ${s.join(",")}`.padEnd(15," ");console.log(`A:${i} F:${h} BC:${a} DE:${n} HL:${g} SP:${c} PC:${r} (cy: ${o}) |[00]0x${r}: ${l.join(" ").padEnd(8," ")}  ${p}`)}};let d=new class{constructor(t){this.mode=t,this.TIMER=new a(this),this.GPU=new n(this),this.MMU=new r(this),this.CPU=new h(this),this.JOYPAD=new g(this),this.APU=new p(this),this.debugger=new u(this),this.CPU.init(),this.GPU.init(),this.MMU.init(),this.TIMER.init(),this.JOYPAD.init(),this.debugger.init(),t?.startsWith("headless")&&(this.APU.init(),this.APU.skip_bios()),this.CPU.skip_bios()}reset(){clearInterval(this.run_interval),this.CPU.reset(),this.MMU.reset(),this.GPU.reset(),this.TIMER.reset(),this.APU.reset(),this.CPU.skip_bios(),this.APU.skip_bios()}run_web(){this.APU.init(),this.APU.skip_bios();this.run_interval=setInterval((()=>{let t,e=new Date;do{if(this.CPU.exec(),this.CPU.stop)break;this.CPU.handle_interrupt()}while(this.TIMER.temp_m<17556);this.TIMER.temp_m=0;do{t=new Date}while((t-e)/1e3<1/62);document.getElementById("fps").innerHTML=Math.round(1e3/(t-e))}),1),console.log("Running!")}run_headless_blocking(t){let e=0;do{if(this.CPU.exec(),this.CPU.handle_interrupt(),t&&(e++,e==t))break}while(!this.CPU.stop)}run_headless_non_blocking(){setImmediate((()=>{this.run_headless_blocking(200),this.CPU.stop||setImmediate((()=>{this.run_headless_non_blocking()}))}))}run(){"headless"==this.mode?this.run_headless_blocking():"headless-non-blocking"==this.mode?this.run_headless_non_blocking():this.run_web()}stop(){this.CPU.stop=!0}},b=!1;function M(){d.reset(),d.GPU.connect_canvas(document.getElementById("screen"))}window.onload=function(){window.emu=d,d.GPU.connect_canvas(document.getElementById("screen")),document.getElementById("run_button").onclick=()=>function(){b&&M();let t=document.getElementById("rom").value;d.MMU.load_rom_ajax(t,(()=>{console.log("rom loaded"),b=!0,d.run()}))}(),document.getElementById("reset_button").onclick=()=>M(),window.onkeydown=t=>d.JOYPAD.keydown(t),window.onkeyup=t=>d.JOYPAD.keyup(t)};
//# sourceMappingURL=index.58f9c11a.js.map
